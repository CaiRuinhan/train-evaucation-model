breed [passengers passenger]
breed [staff-members staff-member]
breed [fire-tiles a-fire-tile]
breed [smoke-tiles a-smoke-tile]

passengers-own [
  in-seat?
  safe?
]

patches-own[
  accessible?
  busy?
  hasFire?
]

to setup
  __clear-all-and-reset-ticks
  initialize-train
  initialize-passengers
  initialize-staff
  initialize-fire
  reset-ticks
end

to go
  let passengers-in-seat (passengers with [in-seat? = true])
  spread-fire
  spread-smoke
  move-passengers
  tick
end 

to initialize-train
  import-pcolors "images/train3.png"
  ask patches [
    if pcolor = black
    [
      set accessible? true
    ]
    if pcolor > 23 and pcolor < 28 [
    set pcolor cyan
    ]
  ]

end

to initialize-passengers
  create-passengers 30 [
    set shape "person"
    set color yellow  
    setxy random-xcor random-ycor
    set size 1.5
    set safe? false    
    move-to one-of patches with [ pcolor = blue ]
  ]

end

to initialize-staff
  create-staff-members 6 [
    set shape "person"
    set color red 
    setxy random-xcor random-ycor
    set size 1.5
    move-to one-of patches with [ pcolor > 40 and pcolor < 70 ]
  ]
end

to initialize-fire
ask n-of 1 patches with [pcolor = black or pcolor = white]
  [
      sprout-fire-tiles 1
      [
      set shape "fire"
      set color red
      set size 2
      set hasFire? true
      ]
  ]  
end


to spread-fire
  ask n-of 2 patches with [pcolor = white or pcolor = grey]
  [
    if any? neighbors with [count fire-tiles-here > 0] [
      sprout-fire-tiles 1 [
        set shape "fire"
        set color red
        set size 2
        set hasFire? true
      ]
    ]
  ]
end


to spread-smoke
  ask fire-tiles [
    ask neighbors with [pcolor = white and pcolor != grey][
        set pcolor grey 
      ]
    ]

end

to move-passengers
  ask passengers with [safe? = false] [
  ifelse (([pcolor] of patch-at-heading-and-distance -180 1 != cyan))
    [
          forward 0.1
    ]
    [
      set color green
      set safe? true
    ]
    ]
  

end
